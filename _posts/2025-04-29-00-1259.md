---
layout: post
title:  "_gpus_ReturnNotPermittedKillClient "
image: ''
date:   2025-04-29 15:43:24
tags:
- Cocos
description: ''
categories: 
- Cocos
---
#### _gpus_ReturnNotPermittedKillClient 是指由于应用处于gpu不可用状态的时候进行了gpu操作导致被系统强行杀死

这个问题之所以无法完全解决,是因为cocos在IOS端的GL线程是主线程。  
因为mainLoop执行的过程中会阻塞主线程一段时间,这段时间主线程无法接收系统消息(切后台、锁屏之类的消息)。 
如果在这段时间内,用户某些操作导致应用被限制GPU访问(锁屏/切后台等操作),这些限制是立刻发生的,不会等应用完成一次mainLoop,  
那么mainLoop结束的时候swapBuffers就必然导致应用崩溃。  
__这种情况添加任何判断都没有用,因为此时任何状态都是正常的__

要想完全解决必须要保证系统消息及时处理,也就是说mainLoop不能放到主线程,类似flutter那样。


一种可能的绕开方案是,将swapBuffers放到mainLoop最开始,
这样mainLoop执行完毕的时候不会触发GPU访问,同时还能处理系统消息,  
等处理完系统消息之后的下一个mainLoop开始的时候就可以判断应用的状态是否可以访问GPU了。  
__这种方案有个弊端,那就是当前帧的画面下一帧才显示,操作反馈会比正常的慢一帧__
```c++
void Director::drawScene()
{
    // calculate "global" dt
    calculateDeltaTime();
    
    // swap buffers`
    if (_openGLView && _totalFrames > 0)
    {
        _openGLView->swapBuffers();
    }


    //.....
```